<%
    function formatSize(size) {
        if (!size) return '---';
        if (size < 1024) return size + 'B';
        if (size < 1024 * 1024) return (size / 1024).toFixed(2) + 'KB';
        return (size / (1024 * 1024)).toFixed(2) + 'MB';
    }
%>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>管理页面</title>
    <script src="/jquery.min.js" type="text/javascript"></script>
    <style type="text/css">
        body {
            padding: 0 5px;
        }
        body > div {
            line-height: 1.5;
        }
        a {
            color: #0e90d2;
            text-decoration: none;
            transition: all linear .3s 0s;
        }
        a:hover {
            color: #095f8a;
            text-decoration: underline;
        }
        th, td {
            min-width: 160px;
            text-align: center;
        }
        td.operation a {
            margin: 0 3px;
        }
        a.entry {
            display: block;
        }
        .e-none {
            color: lightgray;
        }
    </style>
</head>
<body>
    <h3>管理页面</h3>
    <hr>
    <table rules="all" frames="border" border="1">
        <thead>
            <tr>
                <th>选手</th>
                <% options.problems.forEach(function(name) {%>
                <th><%= name %></th>
                <% }) %>
                <th class="operation">操作</th>
            </tr>
        </thead>
        <tbody>
            <% users.forEach(function(user) { %>
            <tr data-username="<%- user.username %>">
                <td><%= user.username %></td>
                <% options.problems.forEach(function(name) {%>
                <td>
                    <% var entry = user.findSubmitted(name); %>
                    <% if (entry) { %>
                    <a class="entry" href="/admin/code/<%- user.username %>/<%- name %>" target="_blank">
                        <span><%= entry.language %>, <%= formatSize(entry.size) %></span>
                    </a>
                    <% } else { %>
                    <span class="e-none">未提交</span>
                    <% } %>
                </td>
                <% }) %>
                <td class="operation">
                    <% if (user.banned) { %>
                    <a class="b-user-action" href="javascript:;" data-action="pardon">解除封禁</a>
                    <% } else { %>
                    <a class="b-user-action" href="javascript:;" data-action="login">进入</a>
                    <a class="b-user-action" href="javascript:;" data-action="ban">封禁</a>
                    <% } %>
                    <a class="b-user-action" href="javascript:;" data-action="delete">删除</a>
                </td>
            </tr>
            <% }) %>
        </tbody>
    </table>
    <% if (res.locals.user) { %>
    <div>
        <span>当前用户: <%= res.locals.user.username %></span>
        <a href="/user" target="_blank">转到选手页面</a>
        <a id="b-user-logout" href="javascript:;">注销</a>
    </div>
    <% } %>
    <div>
        <input id="b-reload-options" type="button" value="重新加载配置文件">
    </div>
    <div>
        <input id="b-reset-pre" type="button" value="清除全部数据">
        <span id="reset-box" style="display: none;">
            <span>输入管理员密码:</span>
            <input id="b-reset-password" type="password">
            <input id="b-reset-confirm" type="button" value="确认">
        </span>
    </div>
    <div>
        <a href="/admin/logout">退出</a>
    </div>
    <script type="text/javascript">
        $('#b-reload-options').click(function() {
            $.ajax({
                url: '/admin/reload-options',
                method: 'POST',
                dataType: 'json'
            }).done(function(data) {
                if (data.success) {
                    location.reload();
                } else {
                    alert("失败: " + data.message);
                }
            }).fail(function() {
                alert("未知错误");
            });
        });
        $('#b-user-logout').click(function() {
            $.ajax({
                method: 'POST',
                url: '/admin/user-action/logout'
            }).done(function(data) {
                if (data.success) {
                    location.reload();
                } else {
                    alert("操作失败: " + data.message);
                }
            }).fail(function() {
                alert("未知错误");
            });
        });
        $('.b-user-action').click(function() {
            var $this = $(this);
            var username = $this.parents('tr').attr('data-username');
            var action = $this.attr('data-action');
            if (action === 'delete' && !confirm("确认删除用户 " + username + " ?")) return;
            $.ajax({
                method: 'POST',
                url: '/admin/user-action/' + action,
                data: {
                    username: username
                },
                dataType: 'json'
            }).done(function(data) {
                if (data.success) {
                    if (action === 'login') {
                        location.href = "/user";
                    } else {
                        location.reload();
                    }
                } else {
                    alert("操作失败: " + data.message);
                }
            }).fail(function() {
                alert("未知错误");
            });
        });
        $('#b-reset-pre').click(function() {
            $('#reset-box').show();
        });
        $('#b-reset-confirm').click(function() {
            let $password = $('#b-reset-password');
            let password = $password.val();
            if (!password) {
                $password.focus();
                return;
            }
            if (!confirm('确认清除全部数据?')) return;
            $.ajax({
                method: 'POST',
                url: '/admin/reset',
                data: {
                    password: password
                },
                dataType: 'json'
            }).done(function(data) {
                if (data.success) {
                    location.reload();
                } else {
                    alert("操作失败: " + data.message);
                }
            }).fail(function() {
                alert("未知错误");
            });
        });
    </script>
</body>
</html>