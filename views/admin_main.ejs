<%
    function formatSize(size) {
        if (!size) return '---';
        if (size < 1024) return size + 'B';
        if (size < 1024 * 1024) return (size / 1024).toFixed(2) + 'KB';
        return (size / (1024 * 1024)).toFixed(2) + 'MB';
    }
%>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>管理页面</title>
    <script src="/jquery.min.js" type="text/javascript"></script>
    <style type="text/css">
        body {
            padding: 0 5px;
        }
        body > div {
            line-height: 1.5;
        }
        a {
            color: #0e90d2;
            text-decoration: none;
            transition: all linear .3s 0s;
        }
        a:hover {
            color: #095f8a;
            text-decoration: underline;
        }
        th, td {
            min-width: 160px;
            text-align: center;
        }
        a.entry {
            display: block;
        }
        .e-none {
            color: lightgray;
        }
    </style>
</head>
<body>
    <h3>管理页面</h3>
    <hr>
    <table rules="all" frames="border" border="1">
        <thead>
            <tr>
                <th>选手</th>
                <% options.problems.forEach(function(name) {%>
                <th><%= name %></th>
                <% }) %>
            </tr>
        </thead>
        <tbody>
            <% users.forEach(function(user) { %>
            <tr>
                <td><%= user.username %></td>
                <% options.problems.forEach(function(name) {%>
                <td>
                    <% var entry = user.findSubmitted(name); %>
                    <% if (entry) { %>
                    <a class="entry" href="/admin/code/<%- user.username %>/<%- name %>" target="_blank">
                        <span><%= entry.language %>, <%= formatSize(entry.size) %></span>
                    </a>
                    <% } else { %>
                    <span class="e-none">未提交</span>
                    <% } %>
                </td>
                <% }) %>
            </tr>
            <% }) %>
        </tbody>
    </table>
    <div>
        <span>用户ID:</span>
        <input id="i-username" type="text">
        <input id="b-user-login" type="button" value="登录">
        <input id="b-user-logout" type="button" value="注销">
        <a href="/user" target="_blank">转到选手页面</a>
    </div>
    <div>
        <a href="/admin/logout">退出</a>
    </div>
    <script type="text/javascript">
        $('#b-user-login').click(function() {
            var $input = $('#i-username');
            var username = $input.val().trim();
            if (!username) {
                $input.select();
                return;
            }
            $.ajax({
                method: 'POST',
                url: '/admin/login-as-user',
                data: {
                    username: username
                },
                dataType: 'json'
            }).done(function(data) {
                if (data.success) {
                    alert("登陆成功");
                } else {
                    alert("失败: " + data.message);
                    $input.select();
                }
            }).fail(function() {
                alert("网络错误");
            });
        });
        $('#b-user-logout').click(function() {
            $.ajax({
                method: 'POST',
                url: '/admin/logout-as-user',
                dataType: 'json'
            }).done(function(data) {
                if (data.success) {
                    alert("注销成功");
                } else {
                    alert("失败: " + data.message);
                }
            }).fail(function() {
                alert("网络错误");
            });
        });
    </script>
</body>
</html>